@model IEnumerable<PrjMiddleProject.Models.CommunityPost>

@{
    ViewData["Title"] = "List";
}

<h1>文章清單</h1>

<div class="d-flex justify-content-between align-items-center mb-3 w-100">
    <!-- 左側搜尋表單 -->
    @using (Html.BeginForm())
    {
        <div class="input-group">
            @Html.TextBox("txtKeyword", null, new { @class = "form-control", placeholder = "請輸入關鍵字", aria_label = "Search" })
            <button class="btn btn-outline-secondary" type="submit">查詢</button>
        </div>
    }

    <!-- 右側新增按鈕 -->
    <button type="button" id="btnCreate" class="main-btn success-btn-outline rounded-full btn-hover">
        <i class="bi bi-person-plus-fill">新增文章</i>
    </button>
</div>

<div class="table-responsive">
    <table class="table table-bordered table-hover text-center align-middle">
        <thead class="table-light">
            <tr>
                <th style="width: 70px;">文章編號</th>
                <th style="width: 85px;">會員編號</th>
                <th>貼文標題</th>
                <th>貼文內容</th>
                <th style="width: 115px;">創建時間</th>
                <th style="width: 115px;">更新時間</th>
                <th style="width: 100px;">貼文狀態</th>
                <th style="width: 120px;">操作</th>
            </tr>
        </thead>
        <tbody>
            @{
                int count = 0;
                foreach (var item in Model)
                {
                    count++;
                    <tr>
                        <td>@count</td>
                        <td>
    @Html.DisplayFor(modelItem => item.MemberId)
    @{
        var dict = ViewBag.MemberNames as Dictionary<int, string>;
        if (dict != null && dict.ContainsKey(item.MemberId))
        {
            <text> (@dict[item.MemberId])</text>
        }
    }
</td>
                        <td>@Html.DisplayFor(modelItem => item.PostTitle)</td>
                        <td title="@item.PostContent">
                            @(item.PostContent?.Length > 20 ? item.PostContent.Substring(0, 20) + "..." : item.PostContent)
                        </td>
                        <td>@item.CreatedAt.ToString("yyyy/MM/dd HH:mm:ss")</td>
                        <td>@item.UpdatedAt.ToString("yyyy/MM/dd HH:mm:ss")</td>
                        <td>
                            @if (item.PostStatuses == "已發布")
                            {
                                <span class="badge rounded-pill text-bg-success">發布中</span>
                            }
                            else
                            {
                                <span class="badge rounded-pill text-bg-danger">已刪除</span>
                            }
                        </td>
                        <td>
                            <div class="btn-group" role="group" aria-label="操作按鈕">
                                <button class="btn btn-outline-primary edit-btn" data-id="@item.PostId">編輯</button>
                                @if (item.PostStatuses == "已發布")
                                {
                                    <button class="btn btn-outline-danger toggle-status-btn" data-id="@item.PostId">刪除</button>
                                }
                                else
                                {
                                    <button class="btn btn-outline-success toggle-status-btn" data-id="@item.PostId">恢復</button>
                                }
                              </div>
                        </td>
                    </tr>
                }
            }
        </tbody>
    </table>
</div>

<!-- 跳出軟刪除視窗 -->
<div class="modal fade" id="createModal" tabindex="-1" aria-labelledby="createModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">新增文章</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="關閉"></button>
            </div>
            <div class="modal-body" id="createModalBody">
                <!-- AJAX 載入的表單會放這裡 -->
            </div>
        </div>
    </div>
</div>

<!-- 跳出編輯視窗 -->
<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">編輯會員</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="editModalBody">
                <!-- AJAX 載入的表單會放這裡 -->
            </div>
        </div>
    </div>
</div>


@section Scripts {
    <script>
        $(document).ready(function () {
            // 點擊新增文章按鈕時發送 AJAX 載入 Create 表單
            $("#btnCreate").click(function () {
                $.ajax({
                    url: '/Posts/Create',
                    type: 'GET',
                    success: function (html) {
                        $('#createModalBody').html(html);
                        $('#createModal').modal('show');
                    },
                    error: function () {
                        alert('載入表單失敗');
                    }
                });
            });
        });

        // 軟刪除
        $(".toggle-status-btn").click(function () {
            const postId = $(this).data("id");
            const isDelete = $(this).text().trim() === "刪除"; // 判斷是刪除還是恢復
            const message = isDelete ? "確定要刪除嗎？" : "確定要恢復嗎？";

            if (!confirm(message)) {
                return; // 使用者按取消就不繼續
            }

            $.ajax({
                url: '/Posts/ToggleStatus',
                type: 'POST',
                data: { id: postId },
                success: function (res) {
                    if (res.success) {
                        alert(res.newStatus);
                        location.reload();
                    } else {
                        alert("操作失敗");
                    }
                },
                error: function () {
                    alert("伺服器錯誤");
                }
            });
        });

        // 點擊編輯按鈕 → 載入表單
        $(".edit-btn").click(function () {
            const postId = $(this).data("id");

            $.get(`/Posts/Edit/${postId}`, function (html) {
                $("#editModalBody").html(html);
                $("#editModal").modal("show");
            });
        });

        // 提交表單更新資料
        $(document).on("submit", "#editForm", function (e) {
            e.preventDefault();

            $.ajax({
                url: '/Posts/Edit',
                type: 'POST',
                data: $(this).serialize(),
                success: function (res) {
                    if (res.success) {
                        $("#editModal").modal("hide");
                        location.reload(); // 或更新單行內容
                    } else {
                        alert("儲存失敗");
                    }
                },
                error: function () {
                    alert("伺服器錯誤");
                }
            });
        });

    </script>
}