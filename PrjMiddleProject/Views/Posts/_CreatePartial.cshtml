@model PrjMiddleProject.Models.CommunityPost

<form id="createForm">
    <!-- 會員編號 -->
    <div class="mb-3">
        <label for="MemberId" class="form-label">會員編號</label>
        @Html.DropDownListFor(m => m.MemberId, (SelectList)ViewBag.MemberId, "請選擇會員", new { @class = "form-control" })
        <span class="text-danger field-validation-valid" data-valmsg-for="MemberId" data-valmsg-replace="true"></span>
    </div>

    <!-- 貼文標題 -->
    <div class="mb-3">
        <label for="PostTitle" class="form-label">貼文標題</label>
        @Html.TextBoxFor(m => m.PostTitle, new { @class = "form-control" })
        <span class="text-danger field-validation-valid" data-valmsg-for="PostTitle" data-valmsg-replace="true"></span>
    </div>

    <!-- 貼文內容 -->
    <div class="mb-3">
        <label for="PostContent" class="form-label">貼文內容</label>
        @Html.TextAreaFor(m => m.PostContent, new { @class = "form-control", rows = 5 })
        <span class="text-danger field-validation-valid" data-valmsg-for="PostContent" data-valmsg-replace="true"></span>
    </div>

    <button type="submit" class="btn btn-primary">新增貼文</button>
</form>

<script>
        $("#createForm").submit(function (e) {
        e.preventDefault();

        // 清空所有錯誤訊息
        $(".field-validation-valid").text("");

        // 前端驗證：會員是否有選擇
        const memberId = $("#MemberId").val();
        if (!memberId || memberId === "") {
            $("[data-valmsg-for='MemberId']").text("請選擇會員");
            return; // 中止提交
        }

        $.ajax({
            url: '/Posts/Create',
            type: 'POST',
            data: $(this).serialize(),
            success: function (res) {
                if (res.success) {
                    $('#createModal').modal('hide');
                    location.reload();
                } else {
                    if (res.errors && res.errors.length > 0) {
                        const errorMap = {
                            "PostTitle": "請輸入貼文標題",
                            "PostContent": "請輸入貼文內容",
                            "MemberId": "請選擇會員"
                        };

                        res.errors.forEach(function (error) {
                            const match = error.match(/The (.+?) field/i);
                            if (match && match[1]) {
                                const fieldName = match[1];
                                const message = errorMap[fieldName] || error;
                                $(`[data-valmsg-for='${fieldName}']`).text(message);
                            } else {
                                alert(error);
                            }
                        });
                    } else {
                        alert('新增失敗，沒有錯誤訊息');
                    }
                }
            },
            error: function () {
                alert('發生錯誤，新增失敗');
            }
        });
    });
</script>

