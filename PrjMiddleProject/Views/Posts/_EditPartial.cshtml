@model PrjMiddleProject.Models.CommunityPost

<form id="editForm">
    @Html.HiddenFor(m => m.PostId)

    <div class="mb-3">
        @Html.Label("PostTitle", "文章標題")
        @Html.TextBoxFor(m => m.PostTitle, new { @class = "form-control" })
    </div>

    <div class="mb-3">
        @Html.Label("PostContent", "文章內容")
        @Html.TextAreaFor(m => m.PostContent, new { @class = "form-control", rows = 5 })
    </div>

    <button type="submit" class="btn btn-success">儲存修改</button>
    @if (ViewBag.HasReplies != null)
    {
        <button type="button" class="btn btn-info"
                onclick="toggleReplies(@Model.PostId, this)">
            查看回覆
        </button>

        <div id="replies-container-@Model.PostId" class="mt-3"></div>
    }

    <button type="button" class="btn btn-primary mt-3" data-post-id="@Model.PostId" id="btnAddReply">
        <i class="bi bi-chat-right-text-fill"></i> 新增回覆
    </button>
</form>

<div class="modal fade" id="createReplyModal" tabindex="-1" aria-labelledby="createReplyModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="createReplyModalLabel">新增回覆</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="關閉"></button>
            </div>
            <div class="modal-body" id="createReplyModalBody">
            </div>
        </div>
    </div>
</div>

<!-- 回覆清單區塊：預設隱藏 -->
<div id="replies-container" class="mt-3"></div> <!-- 顯示回覆內容 -->

<script>
    // 處理「新增回覆」按鈕點擊事件
    // 使用事件委派，因為這個按鈕是在 AJAX 載入的內容中
    $(document).off("click", "#btnAddReply").on("click", "#btnAddReply", function () {
        const parentPostId = $(this).data("post-id"); // 獲取當前文章的 PostId

        $.ajax({
            url: `/Posts/CreateReply/${parentPostId}`, // 傳遞父文章 ID
            type: 'GET',
            success: function (html) {
                $('#createReplyModalBody').html(html);
                $('#createReplyModal').modal('show');
            },
            error: function () {
                alert('載入回覆表單失敗');
            }
        });
    });

    // 處理新增回覆表單提交
    $(document).off("submit", "#createReplyForm").on("submit", "#createReplyForm", function (e) {
        e.preventDefault();

        // 清空所有錯誤訊息，限定在當前 modal 內
        $("#createReplyModalBody .field-validation-valid").text("");

        // 前端驗證：會員是否有選擇 (如果回覆也需要選擇會員)
        const memberId = $("#createReplyModalBody #MemberId").val();
        if (!memberId || memberId === "") {
            $("#createReplyModalBody [data-valmsg-for='MemberId']").text("請選擇會員");
            return; // 中止提交
        }

        $.ajax({
            url: '/Posts/CreateReply', // 提交到後端處理新增回覆的 Action
            type: 'POST',
            data: $(this).serialize(),
            success: function (res) {
                if (res.success) {
                    $('#createReplyModal').modal('hide');
                    alert('回覆新增成功！');
                    // 重新載入該文章的回覆區
                    fetch(`/Posts/ViewReplies?postId=${res.data.PostId}`)
                    .then(r => r.text())
                    .then(html => {
                        $(`#replies-container-${res.data.PostId}`).html(html);
                    });
                } else {
                    if (res.errors && res.errors.length > 0) {
                        // 處理後端驗證錯誤，將錯誤訊息顯示在表單上
                        const errorMap = {
                            "MemberId": "請選擇會員",
                            "PostContent": "請輸入回覆內容"
                        };

                        res.errors.forEach(function (error) {
                            const match = error.match(/The (.+?) field/i);
                            if (match && match[1]) {
                                const fieldName = match[1];
                                const message = errorMap[fieldName] || error;
                                $(`#createReplyModalBody [data-valmsg-for='${fieldName}']`).text(message);
                            } else {
                                alert(error);
                            }
                        });
                    } else {
                        alert('新增回覆失敗，沒有錯誤訊息');
                    }
                }
            },
            error: function () {
                alert('發生錯誤，新增回覆失敗');
            }
        });
    });

        function toggleReplies(postId, btn) {
        const container = document.getElementById(`replies-container-${postId}`);

        if (container.innerHTML.trim() !== '') {
            container.innerHTML = '';
            btn.textContent = '查看回覆';
            return;
        }

        container.innerHTML = '載入中...';
        btn.textContent = '收起回覆';

        fetch(`/Posts/ViewReplies?postId=${postId}`)
            .then(r => r.text())
            .then(html => {
                container.innerHTML = html;
            })
            .catch(() => {
                container.innerHTML = '<div class="text-danger">載入失敗</div>';
            });
    }
</script>